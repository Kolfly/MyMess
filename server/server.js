// ================================================
// SERVEUR CHAT APPLICATION - CONFIGURATION COMPL√àTE
// ================================================

// Chargement des variables d'environnement en premier
// C'est crucial car nos autres modules vont avoir besoin de ces variables
require('dotenv').config();

// ================================================
// IMPORTS DES MODULES PRINCIPAUX
// ================================================

// Modules Node.js natifs - ces modules font partie de Node.js lui-m√™me
const express = require('express');        // Framework web pour cr√©er notre API REST
const http = require('http');             // Module natif pour cr√©er le serveur HTTP
const cors = require('cors');             // Gestion des requ√™tes cross-origin pour Angular

// Socket.io pour les communications temps r√©el (WebSocket)
const socketIo = require('socket.io');

// Nos modules personnalis√©s - l'ordre d'import refl√®te les d√©pendances
const sequelize = require('./database/config/database');           // Configuration base de donn√©es
const { notFoundHandler, errorHandler } = require('./middleware/errorMiddleware');  // Gestion des erreurs

// Charger les associations entre les mod√®les
require('./models/associations');

// ================================================
// CR√âATION DE L'APPLICATION ET DU SERVEUR
// ================================================


// Cr√©ation de l'application Express - c'est le c≈ìur de notre API REST
const app = express();

// Cr√©ation du serveur HTTP qui va h√©berger √† la fois Express ET Socket.io
// Cette approche unifi√© nous permet d'avoir REST et WebSocket sur le m√™me port
const server = http.createServer(app);

// ================================================
// CONFIGURATION DES MIDDLEWARES GLOBAUX
// ================================================

// CORS - Permet √† notre frontend Angular de communiquer avec notre API
// Sans cela, les navigateurs bloqueraient les requ√™tes par s√©curit√©
app.use(cors({
  origin: function(origin, callback) {
    // En d√©veloppement, on est plus permissif pour faciliter les tests
    if (process.env.NODE_ENV === 'development') {
      return callback(null, true);
    }
    
    // En production, on contr√¥le strictement les origines autoris√©es
    const allowedOrigins = [
      process.env.FRONTEND_URL,
      'http://localhost:4200',  // Angular dev server par d√©faut
      'http://localhost:3000'   // Notre serveur pour les tests
    ].filter(Boolean);  // Enlever les valeurs undefined/null
    
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Non autoris√© par la politique CORS'));
    }
  },
  credentials: true,  // Autoriser les cookies et headers d'authentification
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
}));

// Parser JSON - permet de lire les donn√©es JSON dans req.body
app.use(express.json({ 
  limit: '10mb',  // Limite de taille pour √©viter les attaques
  verify: (req, res, buf, encoding) => {
    // V√©rification basique de la validit√© du JSON
    try {
      JSON.parse(buf);
    } catch (e) {
      throw new Error('Format JSON invalide');
    }
  }
}));

// Parser URL-encoded - pour les formulaires HTML classiques
app.use(express.urlencoded({ 
  extended: true, 
  limit: '10mb' 
}));


// ================================================
// MIDDLEWARES DE S√âCURIT√â
// ================================================

app.use((req, res, next) => {
  // Supprimer les headers qui r√©v√®lent des informations sur notre stack technique
  res.removeHeader('X-Powered-By');
  
  // Headers de s√©curit√© recommand√©s pour les applications web modernes
  res.setHeader('X-Content-Type-Options', 'nosniff');  // Emp√™che le navigateur de "deviner" les types de fichiers
  res.setHeader('X-Frame-Options', 'DENY');            // Emp√™che l'inclusion dans des iframes (protection contre clickjacking)
  res.setHeader('X-XSS-Protection', '1; mode=block');  // Active la protection XSS du navigateur
  
  next();
});


// ================================================
// CONFIGURATION DE SOCKET.IO
// ================================================

const io = socketIo(server, {
  cors: {
    origin: process.env.FRONTEND_URL || "http://localhost:4200",
    methods: ["GET", "POST"],  // Socket.io utilise principalement ces deux m√©thodes
    credentials: true
  },
  // Configuration optimis√©e pour le d√©veloppement et la production
  transports: ['websocket', 'polling'],  // Websocket en priorit√©, polling en fallback
  pingTimeout: 60000,    // Timeout de connexion (60 secondes)
  pingInterval: 25000    // Intervalle de v√©rification de connexion (25 secondes)
});


// ================================================
// GESTIONNAIRE SOCKET.IO COMPLET
// ================================================

const SocketHandler = require('./sockets/socketHandler');

// Initialiser le gestionnaire WebSocket complet
const socketHandler = new SocketHandler(io);

// Rendre accessible globalement pour les autres services
global.io = io;
global.socketHandler = socketHandler;


// ================================================
// ROUTES DE TEST ET DE DIAGNOSTIC
// ================================================

// Route racine - test de base pour v√©rifier que le serveur r√©pond
app.get('/', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'Serveur de chat fonctionnel !',
    data: {
      name: 'Chat Application API',
      version: '1.0.0',
      status: 'Op√©rationnel',
      database: 'PostgreSQL connect√©',
      websocket: 'Socket.io actif',
      environment: process.env.NODE_ENV || 'development'
    },
    endpoints: {
      health: '/health',
      info: '/info',
      websocket: 'ws://localhost:' + (process.env.PORT || 3000)
    },
    timestamp: new Date().toISOString()
  });
});

// Route de sant√© - crucial pour le monitoring en production
app.get('/health', (req, res) => {
  res.status(200).json({ 
    success: true,
    message: 'Serveur en bonne sant√©',
    checks: {
      database: 'Connected',      // Status de la base de donn√©es
      memory: process.memoryUsage(),  // Utilisation m√©moire
      uptime: process.uptime(),       // Temps depuis le d√©marrage
      version: process.version        // Version de Node.js
    },
    timestamp: new Date().toISOString()
  });
});

// Route d'information d√©taill√©e sur l'API
app.get('/info', (req, res) => {
  res.status(200).json({
    success: true,
    data: {
      name: 'Chat Application API',
      version: '1.0.0',
      description: 'API REST et WebSocket pour application de chat temps r√©el',
      features: [
        'Authentification JWT (√† venir)',
        'Chat temps r√©el via WebSocket',
        'Messages priv√©s et groupes (√† venir)',
        'Gestion des utilisateurs (√† venir)',
        'Base de donn√©es PostgreSQL'
      ],
      technology_stack: {
        runtime: 'Node.js',
        framework: 'Express.js',
        websocket: 'Socket.io',
        database: 'PostgreSQL',
        orm: 'Sequelize'
      }
    },
    timestamp: new Date().toISOString()
  });
});


// ================================================
// ROUTES D'API PRINCIPALES
// ================================================

// Import des routes - VERSION CLEAN
const authRoutes = require('./routes/authRoutes-clean');
const userRoutes = require('./routes/userRoutes-simple');
const messageRoutes = require('./routes/messageRoutes-simple');
const groupRoutes = require('./routes/groupRoutes');

// Configuration des routes principales - R√âACTIVATION PROGRESSIVE
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/messages', messageRoutes);
app.use('/api/groups', groupRoutes);

// Route de test temporaire - R√âACTIV√âE POUR TEST
app.get('/api/test', (req, res) => {
  res.json({
    success: true,
    message: 'Serveur fonctionnel - test sans autres routes'
  });
});

// üìã LISTE DE TOUTES LES ROUTES DISPONIBLES
app.get('/api/routes', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'Liste de toutes les routes disponibles',
    routes: {
      auth: {
        base_url: '/api/auth',
        routes: [
          'POST   /register                - Inscription utilisateur',
          'POST   /login                   - Connexion utilisateur', 
          'POST   /refresh                 - Renouveler le token',
          'POST   /resend-verification     - Renvoyer email de v√©rification',
          'GET    /me                      - Mon profil (auth requise)',
          'PUT    /profile                 - Modifier mon profil (auth requise)',
          'PUT    /change-password         - Changer mot de passe (auth requise)',
          'PUT    /status                  - Changer mon statut (auth requise)',
          'POST   /logout                  - D√©connexion (auth requise)',
          'GET    /stats                   - Mes statistiques (auth requise)',
          'GET    /search?q=terme          - Rechercher utilisateurs (auth requise)',
          'GET    /global-stats            - Statistiques globales',
          'GET    /test                    - Test authentification (auth requise)'
        ]
      },
      users: {
        base_url: '/api/users',
        routes: [
          'GET    /test                    - Test routes utilisateur (auth requise)',
          'GET    /stats                   - Statistiques publiques',
          'GET    /search?q=terme          - Rechercher utilisateurs (auth requise)',
          'GET    /me/stats                - Mes stats d√©taill√©es (auth requise)',
          'GET    /online                  - Utilisateurs en ligne',
          'GET    /statistics              - Statistiques d√©taill√©es (auth requise)',
          'GET    /:userId                 - Profil utilisateur par ID (auth requise)',
          'PUT    /profile                 - Modifier profil (auth requise)',
          'PUT    /status                  - Modifier statut (auth requise)',
          'GET    /public/:userId          - Profil public utilisateur',
          'GET    /check/username/:username - V√©rifier disponibilit√© username',
          'GET    /check/email/:email      - V√©rifier disponibilit√© email',
          'PUT    /last-seen               - Mettre √† jour derni√®re connexion (auth requise)'
        ]
      },
      messages: {
        base_url: '/api/messages',
        routes: [
          'GET    /test                           - Test routes messages (auth requise)',
          'POST   /                              - Envoyer message (auth requise)',
          'PUT    /:messageId                    - Modifier message (auth requise)',
          'DELETE /:messageId                    - Supprimer message (auth requise)',
          'GET    /conversations                 - Mes conversations (auth requise)',
          'POST   /conversations/private         - Cr√©er conversation priv√©e (auth requise)',
          'POST   /conversations/group           - Cr√©er groupe (auth requise)',
          'GET    /conversations/:id             - D√©tails conversation (auth requise)',
          'GET    /conversations/:id/messages    - Messages conversation (auth requise)',
          'POST   /conversations/:id/read        - Marquer comme lu (auth requise)',
          'GET    /stats                         - Statistiques messages (auth requise)'
        ]
      },
      websocket: {
        base_url: 'ws://localhost:3000',
        description: 'WebSocket temps r√©el pour chat instantan√©',
        authentication: 'Token JWT dans auth.token ou headers.authorization',
        events: {
          client_to_server: [
            'message:send          - Envoyer un message',
            'message:edit          - Modifier un message', 
            'message:delete        - Supprimer un message',
            'conversation:join     - Rejoindre une conversation',
            'conversation:leave    - Quitter une conversation',
            'conversation:typing   - Indiquer que l\'utilisateur tape',
            'conversation:read     - Marquer des messages comme lus',
            'user:status           - Changer son statut (online/away/busy)'
          ],
          server_to_client: [
            'welcome               - Message de bienvenue √† la connexion',
            'message:new           - Nouveau message re√ßu',
            'message:edited        - Message modifi√©',
            'message:deleted       - Message supprim√©', 
            'message:sent          - Confirmation d\'envoi',
            'message:read          - Message marqu√© comme lu',
            'user:joined           - Utilisateur rejoint conversation',
            'user:left             - Utilisateur quitte conversation',
            'user:typing           - Utilisateur en train de taper',
            'user:status_changed   - Statut utilisateur chang√©',
            'error                 - Erreur WebSocket'
          ]
        }
      },
      system: {
        base_url: '/',
        routes: [
          'GET    /                        - Informations serveur',
          'GET    /health                  - √âtat de sant√© du serveur',
          'GET    /info                    - Informations d√©taill√©es API',
          'GET    /api/test                - Test g√©n√©ral API',
          'GET    /api/routes              - Cette liste de routes'
        ]
      }
    },
    notes: [
      '(auth requise) = Header: Authorization: Bearer YOUR_JWT_TOKEN',
      'Pour les requ√™tes POST/PUT, envoyer les donn√©es en JSON dans le body',
      'Base URL compl√®te: http://localhost:3000'
    ],
    timestamp: new Date().toISOString()
  });
});


// ================================================
// MIDDLEWARE DE LOGGING DES REQU√äTES
// ================================================

app.use((req, res, next) => {
  const start = Date.now();
  
  // Quand la r√©ponse est termin√©e, calculer le temps de traitement
  res.on('finish', () => {
    const duration = Date.now() - start;
    const logData = {
      method: req.method,
      url: req.originalUrl,
      status: res.statusCode,
      duration: `${duration}ms`,
      ip: req.ip || req.connection.remoteAddress,
      timestamp: new Date().toISOString()
    };
    
    // Logger diff√©remment selon le type de r√©ponse
    if (res.statusCode >= 400) {
    } else if (process.env.NODE_ENV === 'development') {
    }
  });
  
  next();
});

// ================================================
// GESTION DES ERREURS (DOIT √äTRE EN DERNIER)
// ================================================

// Middleware pour les routes non trouv√©es (404)
app.use(notFoundHandler);

// Middleware global de gestion des erreurs
app.use(errorHandler);


// ================================================
// GESTION PROPRE DE LA FERMETURE DU SERVEUR
// ================================================

// Ces gestionnaires permettent au serveur de se fermer proprement
// Cela √©vite les probl√®mes de ports bloqu√©s que nous avons rencontr√©s
process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);

async function gracefulShutdown(signal) {
  
  try {
    // Fermer les connexions Socket.io
    io.close(() => {
    });
    
    // Fermer les connexions √† la base de donn√©es
    await sequelize.close();
    
    // Fermer le serveur HTTP
    server.close(() => {
      process.exit(0);
    });
    
  } catch (error) {
    process.exit(1);
  }
}

// ================================================
// D√âMARRAGE DU SERVEUR
// ================================================

const PORT = process.env.PORT || 3000;

// Fonction de d√©marrage qui g√®re les erreurs potentielles
async function startServer() {
  try {
    
    // ================================================
    // SYNCHRONISATION DE LA BASE DE DONN√âES
    // ================================================
    
    
    try {
      // Mode s√ªr maintenant que les tables existent
      await sequelize.sync({ 
        alter: true,     // ‚úÖ Mode s√ªr: Ajuste les tables existantes
        logging: false   // D√©sactiver le logging pour √©viter les erreurs
      });
      
      
    } catch (error) {
      
      // Fallback sur l'initialisation manuelle si sync √©choue
      const { initializeDatabase, safeInitializeDatabase } = require('./database/init-database');
      
      // Utiliser la version s√©curis√©e par d√©faut
      if (process.env.FORCE_DB_RESET === 'true') {
        await initializeDatabase(true);
      } else {
        await safeInitializeDatabase();
      }
    }
    
    // D√©marrer l'√©coute sur le port configur√©
    server.listen(PORT, () => {
    });
    
  } catch (error) {
    process.exit(1);
  }
}

// Lancer le serveur
startServer();

// ================================================
// GESTION DES ERREURS NON CAPTUR√âES
// ================================================

// Ces gestionnaires capturent les erreurs qui pourraient √©chapper
// √† notre gestion normale et √©vitent que le serveur crash brutalement
process.on('uncaughtException', (error) => {
  gracefulShutdown('UNCAUGHT_EXCEPTION');
});

process.on('unhandledRejection', (reason, promise) => {
  gracefulShutdown('UNHANDLED_REJECTION');
});


// ================================================
// EXPORTS POUR LES TESTS (OPTIONNEL)
// ================================================

// Permet d'importer ce serveur dans d'autres fichiers pour les tests
module.exports = { 
  app,    // Application Express
  server, // Serveur HTTP 
  io      // Instance Socket.io
};